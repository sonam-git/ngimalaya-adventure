{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 130, "column": 0}, "map": {"version":3,"sources":["file:///Users/sonamjsherpa/Desktop/ngimalaya-adventure/app/api/customtrek/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport sgMail from '@sendgrid/mail';\n\nsgMail.setApiKey(process.env.SENDGRID_API_KEY || '');\n\ninterface CustomTrekData {\n  fullName: string;\n  country: string;\n  availableDays: string;\n  preferredDate: string;\n  destination: string;\n  email: string;\n  message?: string;\n  // Honeypot field\n  website?: string;\n}\n\nconst EMAIL_REGEX = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;\n\nconst DISPOSABLE_DOMAINS = [\n  'tempmail.com', 'throwaway.email', 'guerrillamail.com', 'mailinator.com',\n  '10minutemail.com', 'trashmail.com', 'temp-mail.org', 'yopmail.com',\n  'sharklasers.com', 'maildrop.cc', 'getnada.com', 'fakeinbox.com',\n  'spamgourmet.com', 'tempinbox.com', 'dispostable.com'\n];\n\nconst SUSPICIOUS_PATTERNS = [\n  /<script/i,\n  /javascript:/i,\n  /on\\w+=/i,\n  /<iframe/i,\n  /eval\\(/i,\n  /onclick/i,\n  /onerror/i,\n  /data:text\\/html/i,\n  /<object/i,\n  /<embed/i\n];\n\nconst rateLimitMap = new Map<string, { count: number; timestamp: number }>();\nconst RATE_LIMIT_WINDOW = 60 * 60 * 1000;\nconst MAX_REQUESTS_PER_WINDOW = 5;\n\nfunction validateEmail(email: string): boolean {\n  if (!EMAIL_REGEX.test(email)) return false;\n  const domain = email.split('@')[1]?.toLowerCase();\n  if (DISPOSABLE_DOMAINS.includes(domain)) return false;\n  return true;\n}\n\nfunction sanitizeInput(input: string): string {\n  const sanitized = input.replace(/<[^>]*>/g, '');\n  \n  for (const pattern of SUSPICIOUS_PATTERNS) {\n    if (pattern.test(sanitized)) {\n      throw new Error('Suspicious content detected');\n    }\n  }\n  \n  return sanitized.trim();\n}\n\nfunction checkRateLimit(identifier: string): boolean {\n  const now = Date.now();\n  const record = rateLimitMap.get(identifier);\n  \n  if (!record) {\n    rateLimitMap.set(identifier, { count: 1, timestamp: now });\n    return true;\n  }\n  \n  if (now - record.timestamp > RATE_LIMIT_WINDOW) {\n    rateLimitMap.set(identifier, { count: 1, timestamp: now });\n    return true;\n  }\n  \n  if (record.count >= MAX_REQUESTS_PER_WINDOW) {\n    return false;\n  }\n  \n  record.count++;\n  return true;\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const clientIP = request.headers.get('x-forwarded-for') || \n                     request.headers.get('x-real-ip') || \n                     'unknown';\n    \n    if (!checkRateLimit(clientIP)) {\n      return NextResponse.json(\n        { error: 'Too many requests. Please try again later.' },\n        { status: 429 }\n      );\n    }\n    \n    const data: CustomTrekData = await request.json();\n    \n    // Honeypot check\n    if (data.website) {\n      console.log('Bot detected via honeypot');\n      return NextResponse.json({ success: true });\n    }\n    \n    // Validate required fields\n    if (!data.fullName || !data.email || !data.country || \n        !data.availableDays || !data.preferredDate || !data.destination) {\n      return NextResponse.json(\n        { error: 'Missing required fields' },\n        { status: 400 }\n      );\n    }\n    \n    // Validate email\n    if (!validateEmail(data.email)) {\n      return NextResponse.json(\n        { error: 'Invalid or disposable email address' },\n        { status: 400 }\n      );\n    }\n    \n    // Sanitize inputs\n    const sanitizedData = {\n      fullName: sanitizeInput(data.fullName),\n      country: sanitizeInput(data.country),\n      availableDays: sanitizeInput(data.availableDays),\n      preferredDate: sanitizeInput(data.preferredDate),\n      destination: sanitizeInput(data.destination),\n      email: sanitizeInput(data.email),\n      message: data.message ? sanitizeInput(data.message) : '',\n    };\n    \n    // Create email content\n    const emailContent = {\n      to: process.env.NGIMALAYA_EMAIL || 'ngiman81@gmail.com',\n      from: {\n        email: process.env.NGIMALAYA_EMAIL || 'ngiman81@gmail.com',\n        name: 'Ngimalaya Adventure Custom Trek Planner'\n      },\n      replyTo: sanitizedData.email,\n      subject: `Custom Trek Planning Request: ${sanitizedData.destination} - ${sanitizedData.fullName}`,\n      html: `\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <style>\n            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n            .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n            .header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n            .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px; }\n            .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }\n            .section-title { color: #f5576c; font-size: 18px; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #f5576c; padding-bottom: 5px; }\n            .field { margin-bottom: 12px; }\n            .label { font-weight: bold; color: #555; display: inline-block; min-width: 180px; }\n            .value { color: #333; }\n            .highlight { background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 15px 0; }\n            .message-box { background: #f8f9fa; padding: 15px; border-left: 4px solid #f5576c; margin: 15px 0; white-space: pre-wrap; }\n            .footer { text-align: center; margin-top: 20px; color: #666; font-size: 12px; }\n          </style>\n        </head>\n        <body>\n          <div class=\"container\">\n            <div class=\"header\">\n              <h1>üó∫Ô∏è Custom Trek Planning Request</h1>\n              <p>Received: ${new Date().toLocaleString('en-US', { timeZone: 'Asia/Kathmandu' })} NPT</p>\n            </div>\n            \n            <div class=\"content\">\n              <div class=\"section\">\n                <div class=\"section-title\">üë§ Client Information</div>\n                <div class=\"field\"><span class=\"label\">Full Name:</span> <span class=\"value\">${sanitizedData.fullName}</span></div>\n                <div class=\"field\"><span class=\"label\">Email:</span> <span class=\"value\"><a href=\"mailto:${sanitizedData.email}\">${sanitizedData.email}</a></span></div>\n                <div class=\"field\"><span class=\"label\">Country:</span> <span class=\"value\">${sanitizedData.country}</span></div>\n              </div>\n              \n              <div class=\"section\">\n                <div class=\"section-title\">üìÖ Trek Planning Details</div>\n                <div class=\"field\"><span class=\"label\">Destination:</span> <span class=\"value\"><strong>${sanitizedData.destination}</strong></span></div>\n                <div class=\"field\"><span class=\"label\">Available Days:</span> <span class=\"value\">${sanitizedData.availableDays} days</span></div>\n                <div class=\"field\"><span class=\"label\">Preferred Date:</span> <span class=\"value\">${sanitizedData.preferredDate}</span></div>\n              </div>\n              \n              ${sanitizedData.message ? `\n              <div class=\"section\">\n                <div class=\"section-title\">üí¨ Additional Details</div>\n                <div class=\"message-box\">${sanitizedData.message}</div>\n              </div>\n              ` : ''}\n              \n              <div class=\"highlight\">\n                <strong>‚ö†Ô∏è Action Required:</strong> Create a custom itinerary based on the ${sanitizedData.availableDays}-day timeframe and respond within 24 hours.\n              </div>\n              \n              <div class=\"footer\">\n                <p>This email was sent from Ngimalaya Adventure custom trek planning system</p>\n                <p>IP Address: ${clientIP}</p>\n              </div>\n            </div>\n          </div>\n        </body>\n        </html>\n      `,\n      text: `\nCustom Trek Planning Request\n\nClient Information:\n- Full Name: ${sanitizedData.fullName}\n- Email: ${sanitizedData.email}\n- Country: ${sanitizedData.country}\n\nTrek Planning Details:\n- Destination: ${sanitizedData.destination}\n- Available Days: ${sanitizedData.availableDays}\n- Preferred Date: ${sanitizedData.preferredDate}\n\n${sanitizedData.message ? `Additional Details:\\n${sanitizedData.message}\\n` : ''}\n\nReceived: ${new Date().toLocaleString()}\nIP Address: ${clientIP}\n      `\n    };\n    \n    await sgMail.send(emailContent);\n    \n    return NextResponse.json({\n      success: true,\n      message: 'Custom trek planning request submitted successfully'\n    });\n    \n  } catch (error: unknown) {\n    console.error('Custom Trek API Error:', error);\n    \n    if (error instanceof Error && error.message === 'Suspicious content detected') {\n      return NextResponse.json(\n        { error: 'Invalid input detected' },\n        { status: 400 }\n      );\n    }\n    \n    return NextResponse.json(\n      { error: 'Failed to submit request. Please try again.' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}